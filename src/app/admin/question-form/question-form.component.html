<div class="container mt-4">
  <h2>{{ isEditMode ? 'Edit Question' : 'Add New Question' }}</h2>

  <div *ngIf="isLoading" class="alert alert-info">Loading question data...</div>
  <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

  <form [formGroup]="questionForm" (ngSubmit)="onSubmit()" *ngIf="questionForm">

    <!-- Question Details -->
    <div class="mb-3">
      <label for="questionText" class="form-label">Question Text <span class="text-danger">*</span></label>
      <textarea id="questionText" class="form-control" formControlName="text" rows="3"></textarea>
      <div *ngIf="questionForm.get('text')?.invalid && (questionForm.get('text')?.dirty || questionForm.get('text')?.touched)" class="text-danger mt-1">
        Question text is required.
      </div>
    </div>

    <div class="mb-3">
      <label for="questionDescription" class="form-label">Description (Optional)</label>
      <textarea id="questionDescription" class="form-control" formControlName="description" rows="2"></textarea>
    </div>

    <div class="row mb-3">
      <div class="col-md-6">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="isRequired" formControlName="isRequired">
          <label class="form-check-label" for="isRequired">
            Required Question
          </label>
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="isFirstQuestion" formControlName="isFirstQuestion">
          <label class="form-check-label" for="isFirstQuestion">
            Mark as First Question
          </label>
        </div>
      </div>
    </div>

    <!-- Question Image -->
    <div class="mb-3">
      <label for="questionImage" class="form-label">Question Image (Optional)</label>
      <input type="file" id="questionImage" class="form-control" (change)="onQuestionImageSelected($event)" accept="image/*">
      <div *ngIf="imagePreviews.question" class="mt-2">
        <img [src]="imagePreviews.question" alt="Question Image Preview" style="max-width: 200px; max-height: 150px; object-fit: contain;">
      </div>
    </div>

    <hr>

    <!-- Answer Groups -->
    <h4>Answer Groups</h4>
    <div formArrayName="answerGroups">
      <div *ngFor="let group of answerGroups.controls; let i = index" [formGroupName]="i" class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Group {{ i + 1 }}</span>
          <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeAnswerGroup(i)" [disabled]="answerGroups.length <= 1">Remove Group</button>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label for="groupName{{i}}" class="form-label">Group Name (Optional)</label>
            <input type="text" id="groupName{{i}}" class="form-control" formControlName="name">
          </div>

          <!-- Answers within Group -->
          <h5>Answers</h5>
          <div formArrayName="answers">
            <div *ngFor="let answer of answers(i).controls; let j = index" [formGroupName]="j" class="answer-item mb-3 p-3 border rounded">
              <div class="row">
                <div class="col-md-6">
                   <label for="answerText{{i}}-{{j}}" class="form-label">Answer Text <span class="text-danger">*</span></label>
                  <input type="text" id="answerText{{i}}-{{j}}" class="form-control" formControlName="text">
                   <div *ngIf="answers(i).at(j).get('text')?.invalid && (answers(i).at(j).get('text')?.dirty || answers(i).at(j).get('text')?.touched)" class="text-danger mt-1">
                     Answer text is required.
                   </div>
                </div>
                <div class="col-md-6">
                   <label for="answerImage{{i}}-{{j}}" class="form-label">Answer Image (Optional)</label>
                  <input type="file" id="answerImage{{i}}-{{j}}" class="form-control" (change)="onAnswerImageSelected($event, i, j)" accept="image/*">
                   <div *ngIf="imagePreviews.answers[i + '-' + j]" class="mt-2">
                    <img [src]="imagePreviews.answers[i + '-' + j]" alt="Answer Image Preview" style="max-width: 100px; max-height: 75px; object-fit: contain;">
                  </div>
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-md-6">
                    <div class="form-check">
                       <input class="form-check-input" type="checkbox" id="isCorrect{{i}}-{{j}}" formControlName="isCorrect">
                       <label class="form-check-label" for="isCorrect{{i}}-{{j}}">
                         Correct Answer
                       </label>
                     </div>
                </div>
                 <div class="col-md-6 text-end">
                  <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeAnswer(i, j)" [disabled]="answers(i).length <= 1">Remove Answer</button>
                </div>
              </div>

            </div> <!-- End Answer Item -->
             <button type="button" class="btn btn-sm btn-outline-primary mt-2" (click)="addAnswer(i)">Add Answer to Group {{ i + 1 }}</button>
          </div> <!-- End Answers FormArray -->
        </div> <!-- End Card Body -->
      </div> <!-- End Group Card -->
    </div> <!-- End Answer Groups FormArray -->

    <button type="button" class="btn btn-outline-secondary mb-3" (click)="addAnswerGroup()">Add Answer Group</button>

    <hr>

    <!-- Submit Button -->
    <div class="d-flex justify-content-end">
       <button type="button" class="btn btn-secondary me-2" [routerLink]="['/admin/questions']">Cancel</button>
      <button type="submit" class="btn btn-primary" [disabled]="isLoading || questionForm.invalid">
        <span *ngIf="isLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        {{ isLoading ? ' Saving...' : (isEditMode ? 'Update Question' : 'Create Question') }}
      </button>
    </div>

  </form>
</div>
